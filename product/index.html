<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="icon" type="image/png" href="/images/logo-ohne-schrift.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/logo-ohne-schrift.png">
</head>
<body>
    <!-- Header -->
    <header class="shop-header product-header">
        <div class="header-left">
            <!-- Platzhalter, damit das Logo bei Desktop-Ansicht mittig bleibt -->
        </div>
        <div class="logo-container">
            <a href="/shop">
                <img src="/images/logo.jpg" alt="Shop Logo" class="logo">
            </a>
        </div>
        <div id="cart-icon" class="cart-icon-container-prod">
            <img src="/images/shopping-bag.png" alt="Warenkorb" class="cart-icon">
            <span id="cart-count" class="cart-count">0</span>
        </div>
    </header>

    <!-- Produktdetails -->
    <main class="product-page">
        <div id="product-detail-container" class="product-detail-container">
            <div class="product-detail-wrapper">
                <div class="product-main-image-container">
                    <!-- Hauptbild wird dynamisch eingefügt -->
                </div>
                <div class="product-thumbnail-container">
                    <!-- Thumbnails werden dynamisch eingefügt -->
                </div>

                <!-- Produktinformationen -->
                <section class="product-info">
                    <!-- Produktinformationen wie Name, Preis, Beschreibung etc. werden dynamisch eingefügt -->
                </section>
            </div>
        </div>
    </main>

    <!-- Warenkorb Slide-in Menü -->
    <div id="cart-popup" class="cart-popup">
        <div class="cart-popup-header">
            <h2>Cart</h2>
            <button id="close-cart" class="close-cart-button">&times;</button>
        </div>
        <div id="cart-items" class="cart-items-container">
            <!-- Warenkorb Artikel werden hier dynamisch von JavaScript eingefügt -->
        </div>
        
        <div class="cart-total">
            <div class="cart-total-text">Total Amount:</div>
            <div class="cart-total-divider"></div> <!-- Trennlinie -->
            <div class="cart-total-value" id="total-amount">€0.00</div>
        </div>
    
        <div class="cart-contact-info">
            <div id="paypal-button-container"></div> <!-- PayPal Button wird hier gerendert -->
            <p class="empty-cart-message" id="empty-cart-message" style="display: none;">Your Cart is Empty</p>
        </div>
    </div>

    <script>
        async function loadPayPalSdk() {
            try {
                const response = await fetch('/.netlify/functions/get-paypal-client-id');
                const { clientId } = await response.json();

                if (!clientId) {
                    throw new Error('Client ID not found');
                }

                const script = document.createElement('script');
                script.src = `https://www.paypal.com/sdk/js?client-id=${clientId}&currency=EUR`;
                document.head.appendChild(script);

                console.log('PayPal SDK loaded successfully');
            } catch (error) {
                console.error('Failed to load PayPal SDK:', error);
                alert('Error loading PayPal. Please try again.');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadPayPalSdk();

            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const paypalButtonContainer = document.getElementById('paypal-button-container');
            const emptyCartMessage = document.getElementById('empty-cart-message');

            if (cart.length === 0) {
                // Zeige die leere Warenkorb-Nachricht
                emptyCartMessage.style.display = 'block';
                paypalButtonContainer.style.display = 'none';
            } else {
                // Zeige den PayPal-Button und verstecke die leere Warenkorb-Nachricht
                emptyCartMessage.style.display = 'none';

                paypal.Buttons({
                    style: {
                        layout: 'vertical',
                        color: 'blue',
                        shape: 'rect',
                        label: 'checkout',
                    },
                    createOrder: async () => {
                        const orderID = await createPayPalOrder(cart.map(item => ({ id: item.id, quantity: item.quantity })));
                        return orderID;
                    },
                    onApprove: async (data, actions) => {
                        try {
                            const captureResult = await capturePayPalOrder(data.orderID);
                            alert('Transaction completed! Thank you for your purchase.');
                            localStorage.removeItem('cart');
                            displayCartItems();
                        } catch (error) {
                            console.error('Error capturing PayPal order:', error);
                            alert('An error occurred while finalizing your payment.');
                        }
                    },
                    onError: (err) => {
                        console.error('PayPal Checkout Error:', err);
                        alert('An error occurred during the checkout process.');
                    }
                }).render('#paypal-button-container');
            }
        });
    </script>

    <script src="/app.js"></script>
</body>
</html>
